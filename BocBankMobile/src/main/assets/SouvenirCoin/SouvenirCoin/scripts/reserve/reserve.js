/*! BUILD: 2016-12-16 */
define(["zepto","common","model","viewcontroller","stackCtrl","checkForm"],function(a,b,c,d,e,f){var g=a.extendCls(d,{services:["PsnCommonQuerySystemDateTime","PsnCoinSellerSwitch","PsnProductInfoQuery"],ejs:"../SouvenirCoin/views/reserve/productlist.ejs",showDetail:function(a){var b=this.getEvtObj(a,"coin-item");if(b&&!(b.length<=0)){var c=b.attr("idx"),d=this.datastore.PsnProductInfoQuery.productList[c];window.app.vStack.add('<div class="product-detail-pane"></div>');var e=new h({id:"product-detail",el:".product-detail-pane",eloper:"html",data:{productInfo:d,now:this.datastore.PsnCommonQuerySystemDateTime.dateTme,smsLock:this.datastore.PsnCoinSellerSwitch.smsLock}});e.load()}}}),h=a.extendCls(d,{services:[],ejs:"../SouvenirCoin/views/reserve/detail.ejs",reserve:function(){window.app.vStack.add('<div class="input-pane"></div>'),new i({id:"input-view",el:".input-pane",eloper:"html",data:this.data}).load()},notInTime:function(){var a=this.data.productInfo.startTime.replace(/(\d{2})/g,"$1:").replace(/(.*).{1}/,"$1"),c=this.data.productInfo.endTime.replace(/(\d{2})/g,"$1:").replace(/(.*).{1}/,"$1");b.showMessage("请在"+a+"~"+c+"进行预约")},notStart:function(){b.showMessage("预约还未开始")},ended:function(){b.showMessage("预约已结束")},reserveRecordQry:function(){b.params.targetRouter={routerKey:"SouvenirCoin_query",excuteFun:"init",isExcuteInit:!0,funArgs:[{productId:this.data.productInfo.productId,startDate:this.data.productInfo.startDate,endDate:this.data.productInfo.endDate,sellStartDate:this.data.productInfo.sellStartDate,sellEndDate:this.data.productInfo.sellEndDate,maxNum:this.data.productInfo.maxNum,now:this.data.now,smsLock:this.data.smsLock}]},b.triggerRouter(b.params.targetRouter)},back:function(){window.app.vStack.prev()}}),i=a.extendCls(d,{service:[],ejs:"../SouvenirCoin/views/reserve/input.ejs",upcase:function(a){var b=this.getEvtObj(a,"eobj");b.val(b.val().replace(/\u2006/g,"").toUpperCase())},idSelect:function(){var a=new j({id:"selView"}),c=this;b.fullLayer.show({view:a,classes:"halfLayer",onSure:function(a){var b="01"==a?"身份证":"护照";c.domNode.find(".identyType").text(b),c.domNode.find('input[name="identyType"]').val(a),c.domNode.find('input[name="identyTypeText"]').val(b),"01"==a?c.domNode.find('input[name="identyNumber"]').attr("validate","{required:true,reg01:true}"):c.domNode.find('input[name="identyNumber"]').attr("validate","{required:true,reg604:true}")}})},countSelect:function(){var a=new k({id:"selView",data:this.data}),c=this;b.fullLayer.show({view:a,classes:"halfLayer",onSure:function(a){c.domNode.find(".r-count").text(a),c.domNode.find('input[name="count"]').val(a)}})},citySelect:function(){var a=new l({id:"citySelector",data:this.data}),c=this;b.fullLayer.show({view:a,onSure:function(a){c.domNode.find(".r-bankName").text(a.bankName),c.domNode.find('input[name="bankName"]').val(a.bankName),c.domNode.find('input[name="bankId"]').val(a.bankId),c.domNode.find('input[name="orgId"]').val(a.orgId),c.domNode.find('input[name="bankmobile"]').val(a.bankmobile),c.domNode.find('input[name="orgProvID"]').val(a.orgProvID),c.domNode.find('input[name="orgCityID"]').val(a.orgCityID),c.domNode.find('input[name="province"]').val(a.province),c.domNode.find('input[name="address"]').val(a.address),c.domNode.find(".bank-address").show().find(".r-bankAdress").text(a.address)}})},next:function(){if(!f.checkAll(this.domNode))return!1;if("请选择"==this.domNode.find(".r-bankName").text().trim())return b.showMessage("请选择兑换网点"),!1;var a=this.getViewData();"01"==a.identyType&&(a.identyNumber=a.identyNumber.toUpperCase());var c={productInfo:this.data.productInfo,inputInfo:a};window.app.vStack.add('<div class="confirm-pane"></div>'),new m({id:"reserve-confirm-view",el:".confirm-pane",eloper:"html",data:c}).load()},back:function(){window.Router.backStackView()}}),j=a.extendCls(d,{templateString:"<div class='entry-type'><ul><li class='standli title'>请选择证件类型</li><li class='standli' idx='01' def_event='{click: \"onSelectId1\"}'>身份证</li><li class='standli' idx='03' def_event='{click: \"onSelectId3\"}'>护照</li></ul></div>",onSelectId1:function(){b.fullLayer.sure("01")},onSelectId3:function(){b.fullLayer.sure("03")}}),k=a.extendCls(d,{ejs:"../SouvenirCoin/views/reserve/CountSelector.ejs",onSelectoCount:function(c){var d=a(c.target||c.srcElement);b.fullLayer.sure(d.text().trim())}}),l=a.extendCls(d,{ejs:"../SouvenirCoin/views/reserve/cityselector.ejs",services:["PsnProvinceInfoQuery"],selecProv:function(b){var d=this.getEvtObj(b,"eobj"),e=(d.attr("provId"),this);e.provs=[],e.cities=[],e.banks=[],e.domNode.find(".provTab span").text(d.text().trim()),c.serviceRequest({service:"PsnProvincialInstitution",params:{productId:d.attr("productId"),province:d.text().trim()}},function(b){e.provs=b,e.cities=e._getCitiesInProv(b,d.text().trim());var c="";if(e.cities.length<=0)c='<div class="selledout">产品已售罄</div>',e.domNode.find(".city").html(a(c));else{for(var f=0;f<e.cities.length;f++)-1==c.indexOf(e.cities[f].city)&&(c+='<li class="eobj" idx="'+f+'">'+e.cities[f].city+'<span><img src="images/right-icon.png" style="width:6px;"></span></li>');e.domNode.find(".city").html(a(c).on("click",a.proxy(e.selectCity,e)))}e.showCityPane()})},selectCity:function(b){var c=this.getEvtObj(b,"eobj"),d=c.text().trim();this.domNode.find(".cityTab span").text(c.text().trim()),this.areas=this._getAreasInCity(d);var e="";if(this.areas.length<=0)e='<div class="selledout">产品已售罄</div>',_t.domNode.find(".area").html(a(e));else{for(var f=0;f<this.areas.length;f++)-1==e.indexOf(this.areas[f].county)&&(e+='<li class="eobj" idx="'+f+'">'+this.areas[f].county+'<span><img src="images/right-icon.png" style="width:6px;"></span></li>');this.domNode.find(".area").html(a(e).on("click",a.proxy(this.selectArea,this)))}this.showAreaPane()},selectArea:function(b){var c=this.getEvtObj(b,"eobj"),d=c.text().trim();this.domNode.find(".areaTab span").text(c.text().trim()),this.banks=this._getBanksInArea(d);var e="";if(this.banks.length<=0)e='<div class="selledout">产品已售罄</div>',_t.domNode.find(".bank").html(a(e));else{for(var f=0;f<this.banks.length;f++)e+='<li class="eobj" idx="'+f+'"><span><a>'+this.banks[f].bankName+"</a><br><a>"+this.banks[f].address+'</a></span><span class="networkInfo-amount"><a>剩余额度</a><br><a>'+this.banks[f].quoteUnused+"</a></li>";this.domNode.find(".bank").html(a(e).on("click",a.proxy(this.selectBank,this)))}this.showBankPane()},selectBank:function(a){var c=this.getEvtObj(a,"eobj"),d=c.attr("idx"),e=this.banks[d];b.fullLayer.sure(e)},showProvPane:function(){this.domNode.find(".cityTab, .areaTab, .bankTab").hide().removeClass("tabSelected").find("span").text("请选择"),this.domNode.find(".network .provTab").show().addClass("tabSelected"),this.domNode.find(".networkInfo .selected").hide().removeClass("selected"),this.domNode.find(".networkInfo .prov").show().addClass("selected")},showCityPane:function(){this.domNode.find(".tabSelected").removeClass("tabSelected"),this.domNode.find(".areaTab, .bankTab").hide().find("span").text("请选择"),this.domNode.find(".network .cityTab").show().addClass("tabSelected"),this.domNode.find(".networkInfo .selected").hide().removeClass("selected"),this.domNode.find(".networkInfo .city").show().addClass("selected")},showAreaPane:function(){this.domNode.find(".tabSelected").removeClass("tabSelected"),this.domNode.find(".bankTab").hide().find("span").text("请选择"),this.domNode.find(".network .areaTab").show().addClass("tabSelected"),this.domNode.find(".networkInfo .selected").hide().removeClass("selected"),this.domNode.find(".networkInfo .area").show().addClass("selected")},showBankPane:function(){this.domNode.find(".tabSelected").removeClass("tabSelected"),this.domNode.find(".network .bankTab").show().addClass("tabSelected"),this.domNode.find(".networkInfo .selected").hide().removeClass("selected"),this.domNode.find(".networkInfo .bank").show().addClass("selected")},back:function(a){b.fullLayer.close(a)},_getCitiesInProv:function(a,b){for(var c=[],d=0;d<a.length;d++)a[d].province==b&&c.push(a[d]);return c},_getAreasInCity:function(a){for(var b=[],c=0;c<this.cities.length;c++)this.cities[c].city==a&&b.push(this.cities[c]);return b},_getBanksInArea:function(a){for(var b=[],c=0;c<this.areas.length;c++)this.areas[c].county==a&&b.push(this.areas[c]);return b}}),m=a.extendCls(d,{ejs:"../SouvenirCoin/views/reserve/confirmView.ejs",services:["PSNCreatConversationLoginPre"],back:function(){window.Router.backStackView()},refreshVldCode:function(){this.domNode.find(".validationChar").val(""),this.domNode.find(".validationImg").attr("src","http://22.188.43.149/CoinSeller/ImageValidation/validation"+1048575*Math.random())},showAllName:function(){return a(".flip").length>0?!1:(a("body").append(a('<div class="fadetip flip flip-in"></div>').text(this.domNode.find(".cname").text())),void setTimeout(function(){a(".flip").addClass("flip-out").on("webkitAnimationEnd",function(){a(this).remove()},!1)},3e3))},scroll:function(){var b,c=navigator.userAgent.toLowerCase();if(c.indexOf("like mac os x")>0){var d=/os [\d._]*/gi,e=c.match(d);b=(e+"").replace(/[^0-9|_.]/gi,"").replace(/_/gi,".")}var f=b+"";"undefined"!=f&&f.length>0&&(b=b.substring(0,3),7.1>=b&&a("#scroll").css({position:"absolute",top:"-150px"}))},onSubmit:function(){if(!f.checkAll(this.domNode))return!1;var d=a.extend(this.data.inputInfo,{validationChar:this.domNode.find('input[name="validationChar"]').val(),conversationId:this.datastore.PSNCreatConversationLoginPre.conversationId}),e=this;c.serviceRequest({service:"PsnCoinApply",params:d},function(){window.app.vStack.add('<div class="result-pane"></div>'),new n({id:"reserve-result-view",el:".result-pane",eloper:"html",data:e.data}).load()},{errorFun:function(a){b.showMessage(a.message),e.refreshVldCode()}})}}),n=a.extendCls(d,{ejs:"../SouvenirCoin/views/reserve/result.ejs",back:function(){window.Router.backStackView()},reserveRecordQry:function(){b.params.targetRouter={routerKey:"SouvenirCoin_query",excuteFun:"init",isExcuteInit:!0,funArgs:[{productId:this.data.productInfo.productId,startDate:this.data.productInfo.startDate,endDate:this.data.productInfo.endDate,sellStartDate:this.data.productInfo.sellStartDate,sellEndDate:this.data.productInfo.sellEndDate,maxNum:this.data.productInfo.maxNum,now:this.data.now}]},b.triggerRouter(b.params.targetRouter)},showDetail:function(){this.domNode.find(".details").show().html(a("#reserve-confirm-view").find(".confirm").attr("outerHTML")),this.domNode.find(".details .validationchar-row").remove()}});return b.Module.sub({init:function(){b.urlParams.dev||a(".back-to-native").show().on("click",function(){try{b.terminal.android?NativeAPI.NATIVE_goBack():BOCWebViewJavascriptBridge.callHandler("bocCommeCoinBack","",function(){})}catch(a){alert("调用原生关闭方法异常")}}),window.app.vStack.setAsPane(".wrap"),this.reserveView=new g({id:"reserveView",el:".page-content",eloper:"html",className:"coin",data:{qryscope:"0"}}),this.reserveView.load()},backStackView:function(){window.app.vStack.prev()}})});