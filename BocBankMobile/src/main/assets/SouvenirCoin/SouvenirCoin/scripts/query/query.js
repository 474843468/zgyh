/*! BUILD: 2016-12-16 */
define(["zepto","common","model","viewcontroller","checkForm","routesUtil","stackCtrl"],function(a,b,c,d,e,f){var g=a.extendCls(d,{services:["PSNCreatConversationLoginPre"],ejs:"../SouvenirCoin/views/query/query.ejs",username:"",identity:"",identityType:"01",productId:"",sellStartDate:"",sellEndDate:"",maxNum:"",now:"",onLoadFinish:function(){},setData:function(a){this.productId=a.productId,this.sellStartDate=a.sellStartDate,this.sellEndDate=a.sellEndDate,this.maxNum=a.maxNum,this.now=a.now,this.smsLock=a.smsLock},upcase:function(a){var b=this.getEvtObj(a,"eobj");b.val(b.val().replace(/\u2006/g,"").toUpperCase())},onQuery:function(){var b=this;b.username=a("#username").val().trim(),b.identity=a("#identity").val().trim(),e.checkAll(".entry")&&c.interaction({method:f.method.CoinSeller.PsnApplyInfoQuery,params:{identyType:b.identityType,identyNumber:b.identity,name:b.username,productId:b.productId,conversationId:this.datastore.PSNCreatConversationLoginPre.conversationId}},"CoinSeller",function(c){var d=c;d.productId=b.productId,d.sellStartDate=b.sellStartDate,d.sellEndDate=b.sellEndDate,d.maxNum=b.maxNum,d.now=b.now,d.identyType="01"==d.identyType?"身份证":"护照",d.channel="01"==d.channel?"线上渠道":"柜台",window.app.vStack.add('<div class="stackResultView"></div>'),d.name1=b.username,d.identyNumber1=b.identity;var e=b.smsLock,f=new h({id:"result-detail",el:".stackResultView",eloper:"html",data:{data:d},onLoadFinish:function(){"FALSE"==e&&(a("#modify-revise-hide").hide(),a("#repal-revise-hide").hide())}});f.load(),c.conversationId=b.datastore.PSNCreatConversationLoginPre.conversationId,f.setData(c)})},onQueryIdentity:function(){var a=new l({id:"selView"}),c=this;b.fullLayer.show({view:a,classes:"halfLayer",onSure:function(a){c.domNode.find("#identityType").text("01"==a?"身份证":"护照"),"01"==a?c.domNode.find("#identity").attr("validate","{required:true,reg01:true}"):c.domNode.find("#identity").attr("validate","{required:true,reg604:true}"),c.identityType=a}})},onBack:function(){window.Router.backStackView()}}),h=a.extendCls(d,{services:[],ejs:"../SouvenirCoin/views/query/queryResult.ejs",data:{},setData:function(a){this.data=a},onModify:function(){if("柜台"==this.data.channel)return void b.showAlert("柜台预约不可修改",["确定"]);var a=new Date(this.data.now).getTime(),c=new Date(this.data.endDate).getTime(),d=new Date(this.data.startDate).getTime();if(a>c||d>a)return void b.showAlert("非预约期内不可修改预约",["确定"]);window.app.vStack.add('<div class="stackQueryConfirmView"></div>');var e=new i({id:"queryConfirmView",el:".stackQueryConfirmView",eloper:"html",data:{data:this.data}});e.load(),e.setData(this.data)},onCancel:function(){window.app.vStack.add('<div class="stackCancelConfirmView"></div>');var a=new j({id:"cancelConfirmView-detail",el:".stackCancelConfirmView",eloper:"html",data:{data:this.data}});a.load(),a.setData(this.data)},backStackView:function(){window.app.vStack.prev()},onBack:function(){window.app.vStack.prev()}}),i=a.extendCls(d,{services:[],ejs:"../SouvenirCoin/views/query/queryConfirm.ejs",data:{},count:"",onLoadFinish:function(){a("#code").val(""),this.domNode.find(".codePic").attr("src",f.routerPath.validation+"?rnd="+Math.random())},setData:function(a){this.data=a},onCount:function(){var a=this,c=new m({id:"selView",data:{productInfo:{maxNum:a.data.maxNum}}}),a=this;b.fullLayer.show({view:c,classes:"halfLayer",onSure:function(b){a.domNode.find("#count").text(b),a.count=b}})},onModifyConfirm:function(){var d=this;if(e.checkAll(this.domNode)){d.count=a("#count").html().trim();var g={};g.smsValidCode=a("#mobileCode").val().trim(),g.identyType="身份证"==this.data.identyType?"01":"03",g.identyNumber=this.data.identyNumber,g.productId=this.data.productId,g.mobile=this.data.mobile,g.orgId=this.data.orgId,g.count=d.count,g.validationChar=a(".code").val().trim(),g.conversationId=this.data.conversationId,d.identyType="身份证"==this.data.identyType?"01":"03",d.name=this.data.name,d.name1=this.data.name1,d.productId=this.data.productId,d.sellStartDate=this.data.sellStartDate,d.sellEndDate=this.data.sellEndDate,d.maxNum=this.data.maxNum,d.identyNumber=this.data.identyNumber,d.identyNumber1=this.data.identyNumber1,c.interaction({method:f.method.CoinSeller.PsnCoinModify,params:g},"CoinSeller",function(){b.showAlert("预约数量修改成功",["确定"],function(){c.interaction({method:f.method.CoinSeller.PsnApplyInfoQuery,params:{identyType:d.identyType,identyNumber:d.identyNumber1,name:d.name1,productId:d.productId,conversationId:d.data.conversationId}},"CoinSeller",function(a){a.conversationId=d.data.conversationId;var b=a;b.productId=d.productId,b.startDate=d.startDate,b.endDate=d.endDate,b.sellStartDate=d.sellStartDate,b.sellEndDate=d.sellEndDate,b.maxNum=d.maxNum,b.identyType="01"==a.identyType?"身份证":"护照",b.channel="01"==a.channel?"线上渠道":"柜台",b.name1=d.name1,b.identyNumber1=d.identyNumber1,window.app.vStack.prev(),window.app.vStack.prev(),window.app.vStack.add('<div class="stackResultView"></div>');var c=new h({id:"result-detail",el:".stackResultView",eloper:"html",data:{data:b}});c.load(),c.setData(a)})})})}},onGetMobileCode:function(){var d=this,e=a(".code").val().trim();if(""==e)return void b.showAlert("请输入图形验证码",["确定"]);var g=60,h=0,d=this;c.interaction({method:f.method.CoinSeller.PsnCoinConfirmSms,params:{validationChar:a(".code").val().trim(),conversationId:d.data.conversationId}},"CoinSeller",function(){var b=setInterval(function(){return h>=g?(clearInterval(b),a("#codeButton").html("获取验证码").on("click",a.proxy(d.onGetMobileCode,d)),void(h=0)):(h++,void a("#codeButton").html(g-h+"s后可重发").off("click"))},1e3)},{errorFun:function(c){b.showMessage(c.message),a("#code").val(""),a("#codePic").attr("src",f.routerPath.validation+"?rnd="+Math.random())}})},onGetCode:function(){a("#code").val(""),this.domNode.find(".codePic").attr("src",f.routerPath.validation+"?rnd="+Math.random())},backStackView:function(){window.app.vStack.prev()},onBack:function(){window.app.vStack.prev()}}),j=a.extendCls(d,{services:[],ejs:"../SouvenirCoin/views/query/cancelConfirm.ejs",data:{},onLoadFinish:function(){a("#cancle-code").val(""),a("#codePic").attr("src",f.routerPath.validation+"?rnd="+Math.random())},setData:function(a){this.data=a},onCancelConfirm:function(){if(e.checkAll(".entry")){var b={};b.smsValidCode=a("#mobileCode").val().trim(),b.identyType="身份证"==this.data.identyType?"01":"03",b.identyNumber=this.data.identyNumber,b.productId=this.data.productId,b.validationChar=a("#cancle-code").val().trim(),b.conversationId=this.data.conversationId,c.interaction({method:f.method.CoinSeller.PsnCoinApplCancl,params:b},"CoinSeller",function(a){window.app.vStack.add('<div class="stackCancelResultView"></div>');var b=new k({id:"cancelResultView-detail",el:".stackCancelResultView",eloper:"html",data:{data:a}});b.load()})}},onGetMobileCode:function(){var d=this,e=a(".code").val().trim();if(""==e)return void b.showAlert("请输入图形验证码",["确定"]);var g=60,h=0,d=this;c.interaction({method:f.method.CoinSeller.PsnCoinConfirmSms,params:{validationChar:a(".code").val().trim(),conversationId:d.data.conversationId}},"CoinSeller",function(){var b=setInterval(function(){return h>=g?(clearInterval(b),a("#codeCancelButton").html("获取验证码").on("click",a.proxy(d.onGetMobileCode,d)),void(h=0)):(h++,void a("#codeCancelButton").html(g-h+"s后可重发").off("click"))},1e3)},{errorFun:function(c){b.showMessage(c.message),a("#cancle-code").val(""),a("#codePic").attr("src",f.routerPath.validation+"?rnd="+Math.random())}})},onGetCode:function(){a("#cancle-code").val(""),a("#codePic").attr("src",f.routerPath.validation+"?rnd="+Math.random())},backStackView:function(){window.app.vStack.prev()},onBack:function(){window.location.reload()}}),k=a.extendCls(d,{service:[],ejs:"../SouvenirCoin/views/query/cancelResult.ejs",onReserve:function(){window.location.reload()},backStackView:function(){window.app.vStack.prev()},onBack:function(){window.location.reload()}}),l=a.extendCls(d,{templateString:"<div class='entry-type'><ul><li class='standli title'>请选择证件类型</li><li class='standli' idx='01' def_event='{click: \"onSelectId1\"}'>身份证</li><li class='standli' idx='03' def_event='{click: \"onSelectId3\"}'>护照</li></ul></div>",onSelectId1:function(){b.fullLayer.sure("01")},onSelectId3:function(){b.fullLayer.sure("03")}}),m=a.extendCls(d,{ejs:"../SouvenirCoin/views/reserve/CountSelector.ejs",onSelectoCount:function(c){var d=a(c.target||c.srcElement);b.fullLayer.sure(d.text())}});return b.Module.sub({CSSPATH:[],init:function(a){window.app.vStack.add('<div class="record-query-pane"></div>'),this.queryView=new g({id:"queryView",el:".record-query-pane",eloper:"html",className:"query"}),this.queryView.load(),this.queryView.setData(a)},backStackView:function(){window.app.vStack.prev()}})});